CREATE TABLE IF NOT EXISTS process(id INTEGER PRIMARY KEY AUTOINCREMENT,
                     pid INTEGER NOT NULL,
                     pp_id INTEGER,
                     image TEXT,
                     desc_address TEXT,
                     first_seen REAL NOT NULL,
                     terminated_time REAL,
                     suspicion_score INTEGER DEFAULT 0,
                     UNIQUE(pid,desc_address) ON CONFLICT ABORT,
                     FOREIGN KEY (pp_id) REFERENCES process(id));

CREATE TABLE IF NOT EXISTS resource(id INTEGER PRIMARY KEY AUTOINCREMENT,
                      name TEXT NOT NULL UNIQUE,
                      first_seen REAL NOT NULL,
                      type TEXT CHECK( type IN ('F', 'R') ));

CREATE TABLE IF NOT EXISTS operation(id INTEGER PRIMARY KEY AUTOINCREMENT,
                    p_id INTEGER NOT NULL,
                    target_p_id INTEGER,
                    r_id INTEGER,
                    op TEXT CHECK( op IN ('CREATE', 'OPEN', 'DELETE', 'READ', 'WRITE', 'IMAGE-LOAD',
                    'PROCESS-ACCESS-REQ','REG_CREATE_KEY', 'REG_SET_KEY_VALUE', 'REG_DELETE_KEY',
                    'REG_DELETE_KEY_VALUE', 'REG_RENAME_KEY', 'REG_REPLACE_KEY')) NOT NULL,
                    time REAL NOT NULL,
                    data TEXT,
                    FOREIGN KEY (p_id) REFERENCES process(id),
                    FOREIGN KEY (target_p_id) REFERENCES process(id),
                    FOREIGN KEY (r_id) REFERENCES resource(id));

CREATE TABLE IF NOT EXISTS tcp_operation(id INTEGER PRIMARY KEY AUTOINCREMENT,
                                         time REAL NOT NULL,
                                         p_id INTEGER,
                                         src_host TEXT NOT NULL,
                                         src_port INTEGER NOT NULL,
                                         dst_host TEXT NOT NULL,
                                         dst_port INTEGER NOT NULL,
                                         data TEXT,
                                         FOREIGN KEY(p_id) REFERENCES process(id));

CREATE TABLE IF NOT EXISTS dns_operation(id INTEGER PRIMARY KEY AUTOINCREMENT,
                                         time REAL NOT NULL,
                                         query_id TEXT NOT NULL,
                                         op TEXT CHECK( op IN ("REQUEST", "RESPONSE")) NOT NULL,
                                         host TEXT,
                                         p_id INTEGER,
                                         data TEXT,
                                         FOREIGN KEY(p_id) REFERENCES process(id));

CREATE TABLE IF NOT EXISTS suspicious_behavior(id INTEGER PRIMARY KEY AUTOINCREMENT,
                                            p_id INTEGER NOT NULL,
                                            analyst TEXT NOT NULL,
                                            key TEXT NOT NULL,
                                            value TEXT NOT NULL,
                                            FOREIGN KEY(p_id) REFERENCES process(id));

