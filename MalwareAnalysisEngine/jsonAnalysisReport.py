#!/usr/bin/env python
# encoding: utf-8

'''
Created on Apr 23, 2018

@author: ashaman
'''
import sys
import malware_analyzer
from output.json_output_plugn import JSONOutputPlugin
import json
import os

if len(sys.argv) < 2:
  print("jsonAnalysisReport.py <malware-db.sql>")

jsonOutputPlugin = JSONOutputPlugin()
malwareShell = malware_analyzer.MalwareAnalyzerShell()
malwareShell.do_load_db(sys.argv[1], True)
malwareShell.setOutputPlugin(jsonOutputPlugin)
malwareShell.do_report("")

jsonData = jsonOutputPlugin.getJSONData()
if "Summary" in jsonData:
  summary = jsonOutputPlugin.getJSONData()["Summary"]
  for row in summary:
    descriptorAddr = row["Descriptor Address"]
    malwareShell.do_report(descriptorAddr)
    malwareShell.do_mittree(descriptorAddr)


maxScore = malwareShell.queryMalwareDatabase("SELECT MAX(suspicion_score) FROM process WHERE IMAGE LIKE '%analysis%'").fetchone()
if maxScore[0] is None:
  maxScore = 0
else:
  maxScore = maxScore[0]

rating = malwareShell.getSuspicionRating(maxScore)

filename = os.path.basename(sys.argv[1])
jsonData["Sample"] = {"Name": os.path.splitext(filename)[0], "Suspicion Score": maxScore, "Suspicion Rating": rating}

print(json.dumps(jsonData))
malwareShell.close()
